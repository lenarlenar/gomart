# Техническое задание  

## Накопительная система лояльности «Гофермарт»  

### Общие требования  
Система представляет собой **HTTP API** со следующими требованиями к бизнес-логике:  

- **Регистрация, аутентификация и авторизация** пользователей  
- **Приём номеров заказов** от зарегистрированных пользователей  
- **Учёт и ведение списка переданных номеров заказов** зарегистрированного пользователя  
- **Учёт и ведение накопительного счёта** зарегистрированного пользователя  
- **Проверка принятых номеров заказов** через систему расчёта баллов лояльности  
- **Начисление вознаграждения** за каждый подходящий номер заказа на счёт лояльности пользователя  

## Абстрактная схема взаимодействия с системой  
Ниже представлена абстрактная бизнес-логика взаимодействия пользователя с системой:

1. Пользователь регистрируется в системе лояльности «Гофермарт».  
2. Пользователь совершает покупку в интернет-магазине «Гофермарт» (*гипотетический пункт, не требует реализации*).  
3. Заказ попадает в систему расчёта баллов лояльности (*реализовано в системе расчёта баллов, не требует реализации*).  
4. Пользователь передаёт номер совершённого заказа в систему лояльности.  
5. Система связывает номер заказа с пользователем и сверяет номер с системой расчёта баллов лояльности.  
6. При наличии положительного расчёта баллов лояльности производится начисление баллов на счёт пользователя.  
7. Пользователь списывает доступные баллы для частичной или полной оплаты последующих заказов.  

## Система расчёта баллов лояльности  
Система расчёта баллов является **внешним сервисом в доверенном контуре**. Она работает по принципу «чёрного ящика» и недоступна для инспекции.

- Рассчитывает баллы по сложным алгоритмам, которые могут меняться в любое время.  
- Внешнему потребителю доступна **только информация о количестве начисленных баллов**.  
- Причины наличия или отсутствия начислений неизвестны внешним потребителям.  

## Сводное HTTP API  
Система лояльности «Гофермарт» предоставляет следующие HTTP-хендлеры:

### **Регистрация пользователя**  
**POST** `/api/user/register`  
Формат запроса:
```json
{
    "login": "<login>",
    "password": "<password>"
}  
```
**Коды ответа:**
- `200` — успешная регистрация
- `400` — неверный формат запроса
- `409` — логин уже занят
- `500` — внутренняя ошибка сервера

### **Аутентификация пользователя**  
**POST** `/api/user/login`  
Формат запроса:
```json
{
    "login": "<login>",
    "password": "<password>"
}  
```
**Коды ответа:**
- `200` — успешная аутентификация
- `400` — неверный формат запроса
- `401` — неверная пара логин/пароль
- `500` — внутренняя ошибка сервера

### **Загрузка номера заказа**  
**POST** `/api/user/orders`  
Формат запроса:
```plaintext
12345678903
```
**Коды ответа:**
- `202` — номер принят в обработку
- `400` — неверный формат запроса
- `401` — пользователь не аутентифицирован
- `409` — номер уже загружен другим пользователем
- `422` — неверный формат номера заказа
- `500` — внутренняя ошибка сервера

### **Получение списка загруженных номеров заказов**  
**GET** `/api/user/orders`  
Формат ответа:
```json
[
    {
        "number": "9278923470",
        "status": "PROCESSED",
        "accrual": 500,
        "uploaded_at": "2020-12-10T15:15:45+03:00"
    }
]
```
**Коды ответа:**
- `200` — успешный запрос
- `204` — нет данных
- `401` — пользователь не авторизован
- `500` — внутренняя ошибка сервера

### **Получение текущего баланса пользователя**  
**GET** `/api/user/balance`  
Формат ответа:
```json
{
    "current": 500.5,
    "withdrawn": 42
}
```
**Коды ответа:**
- `200` — успешный запрос
- `401` — пользователь не авторизован
- `500` — внутренняя ошибка сервера

### **Запрос на списание средств**  
**POST** `/api/user/balance/withdraw`  
Формат запроса:
```json
{
    "order": "2377225624",
    "sum": 751
}
```
**Коды ответа:**
- `200` — успешный запрос
- `401` — пользователь не авторизован
- `402` — недостаточно средств
- `422` — неверный номер заказа
- `500` — внутренняя ошибка сервера

### **Взаимодействие с системой расчёта начислений баллов лояльности**  
**GET** `/api/orders/{number}`  
Формат ответа:
```json
{
    "order": "<number>",
    "status": "PROCESSED",
    "accrual": 500
}
```
**Коды ответа:**
- `200` — успешный запрос
- `204` — заказ не зарегистрирован в системе расчёта
- `429` — превышен лимит запросов
- `500` — внутренняя ошибка сервера

## **Конфигурирование сервиса**  
Сервис поддерживает конфигурирование следующими методами:

- **Адрес и порт запуска**: `RUN_ADDRESS` (переменная окружения) или флаг `-a`
- **Адрес подключения к БД**: `DATABASE_URI` (переменная окружения) или флаг `-d`
- **Адрес системы расчёта начислений**: `ACCRUAL_SYSTEM_ADDRESS` (переменная окружения) или флаг `-r`